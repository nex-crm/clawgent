name: Upgrade OpenClaw Instances

on:
  workflow_dispatch:
    inputs:
      version:
        description: "OpenClaw version to deploy (e.g. 2026.2.23)"
        required: true
        default: "2026.2.23"
      dry_run:
        description: "Dry run — list containers but don't upgrade"
        required: false
        type: boolean
        default: false

concurrency:
  group: openclaw-upgrade
  cancel-in-progress: false

jobs:
  upgrade:
    name: Upgrade Running Instances
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 30
    permissions:
      id-token: write
      contents: read

    env:
      INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}
      OPENCLAW_VERSION: ${{ inputs.version }}

    steps:
      - name: Validate version input
        run: |
          if ! echo "$OPENCLAW_VERSION" | grep -qE '^[0-9]{4}\.[0-9]+\.[0-9]+$'; then
            echo "::error::Invalid version format: $OPENCLAW_VERSION (expected YYYY.M.D, e.g. 2026.2.23)"
            exit 1
          fi
          echo "Upgrading to OpenClaw ${OPENCLAW_VERSION}"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup SSM helper
        run: |
          cat > /tmp/ssm_run.sh << 'HELPER'
          ssm_run() {
            local desc="$1" timeout="$2" script="$3"
            echo "=== $desc ==="
            local params
            params=$(jq -n --arg s "$script" \
              '{"commands": ($s | split("\n") | map(select(length > 0)))}')
            local cmd_id
            cmd_id=$(aws ssm send-command \
              --instance-ids "$INSTANCE_ID" \
              --document-name "AWS-RunShellScript" \
              --comment "$desc" \
              --timeout-seconds "$timeout" \
              --parameters "$params" \
              --output text \
              --query 'Command.CommandId') || { echo "Failed to send SSM command" >&2; return 1; }
            if [ -z "$cmd_id" ]; then
              echo "No command ID returned from SSM" >&2; return 1
            fi
            echo "SSM command: $cmd_id"
            local elapsed=0
            while [ "$elapsed" -lt "$timeout" ]; do
              local inv
              inv=$(aws ssm get-command-invocation \
                --command-id "$cmd_id" \
                --instance-id "$INSTANCE_ID" 2>/dev/null || true)
              if [ -z "$inv" ]; then
                sleep 5; elapsed=$((elapsed + 5)); continue
              fi
              local status
              status=$(printf '%s' "$inv" | jq -r '.StatusDetails')
              case "$status" in
                Success)
                  printf '%s' "$inv" | jq -r '.StandardOutputContent'
                  return 0
                  ;;
                Failed|Cancelled|TimedOut|Undeliverable|Terminated)
                  printf '%s' "$inv" | jq -r '.StandardOutputContent'
                  printf '%s' "$inv" | jq -r '.StandardErrorContent' >&2
                  echo "Command failed: $status" >&2
                  return 1
                  ;;
                *)
                  echo "[${elapsed}s] $status..."
                  sleep 5; elapsed=$((elapsed + 5))
                  ;;
              esac
            done
            echo "Timed out after ${timeout}s" >&2
            return 1
          }
          HELPER

      - name: Pull and tag new OpenClaw image
        run: |
          source /tmp/ssm_run.sh
          ssm_run "Pull OpenClaw ${OPENCLAW_VERSION}" 300 "
          set -euo pipefail
          echo \"Pulling OpenClaw ${OPENCLAW_VERSION} from ghcr.io...\"
          docker pull \"ghcr.io/openclaw/openclaw:${OPENCLAW_VERSION}\"
          docker tag \"ghcr.io/openclaw/openclaw:${OPENCLAW_VERSION}\" clawgent-openclaw
          echo \"OpenClaw image ready:\"
          docker images clawgent-openclaw
          echo \"\"
          echo \"Old images:\"
          docker images --filter \"reference=ghcr.io/openclaw/openclaw\" --format \"{{.Repository}}:{{.Tag}} {{.Size}} {{.CreatedSince}}\""

      - name: List running instances
        run: |
          source /tmp/ssm_run.sh
          ssm_run "List running instances" 30 '
          set -euo pipefail
          echo "Running clawgent containers:"
          docker ps --filter "name=clawgent-" --format "table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}" || echo "No containers found"
          echo ""
          echo "Container count: $(docker ps --filter "name=clawgent-" -q | wc -l)"'

      - name: Upgrade all running instances
        if: inputs.dry_run == false
        run: |
          source /tmp/ssm_run.sh
          ssm_run "Upgrade all instances" 900 '
          set -euo pipefail
          LOCAL_TAG="clawgent-openclaw"
          CONTAINERS=$(docker ps --filter "name=clawgent-" --format "{{.Names}}" | grep -v "^$" || true)
          if [ -z "$CONTAINERS" ]; then
            echo "No running clawgent containers found. Done."
            exit 0
          fi
          CONTAINER_COUNT=$(echo "$CONTAINERS" | wc -l)
          echo "Upgrading ${CONTAINER_COUNT} container(s)..."
          UPGRADED=0
          FAILED=0
          for CONTAINER in $CONTAINERS; do
            echo ""
            echo "=== Upgrading: ${CONTAINER} ==="
            PORT_MAPPING=$(docker inspect "$CONTAINER" --format "{{range \$p, \$conf := .HostConfig.PortBindings}}{{range \$conf}}{{.HostPort}}{{end}}{{end}}" 2>/dev/null || echo "")
            VOLUME_MOUNTS=$(docker inspect "$CONTAINER" --format "{{range .Mounts}}{{if eq .Type \"volume\"}}--volume {{.Name}}:{{.Destination}} {{end}}{{end}}" 2>/dev/null || echo "")
            ENV_VARS=$(docker inspect "$CONTAINER" --format "{{range .Config.Env}}-e {{.}} {{end}}" 2>/dev/null || echo "")
            MEMORY=$(docker inspect "$CONTAINER" --format "{{.HostConfig.Memory}}" 2>/dev/null || echo "0")
            MEMORY_SWAP=$(docker inspect "$CONTAINER" --format "{{.HostConfig.MemorySwap}}" 2>/dev/null || echo "0")
            PIDS_LIMIT=$(docker inspect "$CONTAINER" --format "{{.HostConfig.PidsLimit}}" 2>/dev/null || echo "0")
            if [ -z "$PORT_MAPPING" ]; then
              echo "WARNING: Could not extract port mapping for ${CONTAINER}, skipping"
              FAILED=$((FAILED + 1))
              continue
            fi
            echo "Port: ${PORT_MAPPING}:18789"
            echo "Stopping ${CONTAINER}..."
            docker stop "$CONTAINER" --time 30 2>/dev/null || true
            docker rm "$CONTAINER" 2>/dev/null || true
            RESOURCE_FLAGS=""
            if [ "$MEMORY" != "0" ] && [ -n "$MEMORY" ]; then
              RESOURCE_FLAGS="${RESOURCE_FLAGS} --memory=${MEMORY}"
            fi
            if [ "$MEMORY_SWAP" != "0" ] && [ -n "$MEMORY_SWAP" ]; then
              RESOURCE_FLAGS="${RESOURCE_FLAGS} --memory-swap=${MEMORY_SWAP}"
            fi
            if [ "$PIDS_LIMIT" != "0" ] && [ "$PIDS_LIMIT" != "-1" ] && [ -n "$PIDS_LIMIT" ]; then
              RESOURCE_FLAGS="${RESOURCE_FLAGS} --pids-limit=${PIDS_LIMIT}"
            fi
            echo "Creating ${CONTAINER} with new image..."
            docker run -d \
              --name "$CONTAINER" \
              --restart unless-stopped \
              -p "${PORT_MAPPING}:18789" \
              ${VOLUME_MOUNTS} \
              ${ENV_VARS} \
              ${RESOURCE_FLAGS} \
              "${LOCAL_TAG}"
            docker exec -u root "$CONTAINER" chown -R node:node /home/node/.openclaw 2>/dev/null || true
            echo "Running openclaw doctor --fix..."
            docker exec "$CONTAINER" node /app/openclaw.mjs doctor --fix 2>/dev/null || echo "WARNING: doctor --fix failed (non-fatal)"
            echo "Waiting for health..."
            HEALTHY=false
            for i in $(seq 1 15); do
              if docker exec "$CONTAINER" node /app/openclaw.mjs gateway status 2>/dev/null | grep -qi "running\|ok\|ready"; then
                HEALTHY=true
                break
              fi
              sleep 2
            done
            if [ "$HEALTHY" = true ]; then
              echo "${CONTAINER} is healthy"
              UPGRADED=$((UPGRADED + 1))
            else
              echo "WARNING: ${CONTAINER} may not be fully healthy yet"
              UPGRADED=$((UPGRADED + 1))
            fi
          done
          echo ""
          echo "=============================="
          echo "Upgrade complete"
          echo "Upgraded: ${UPGRADED}/${CONTAINER_COUNT}"
          if [ "$FAILED" -gt 0 ]; then
            echo "Failed: ${FAILED}/${CONTAINER_COUNT}"
          fi
          echo "=============================="
          echo ""
          echo "Final container status:"
          docker ps --filter "name=clawgent-" --format "table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}"'

      - name: Dry run summary
        if: inputs.dry_run == true
        run: |
          echo "DRY RUN complete — no containers were modified."
          echo "Review the 'List running instances' step output above."
          echo "Re-run this workflow with dry_run=false to perform the upgrade."
